<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by Umar on 16/01/2017.
 *
 * This is the routes js file: Here you will see a variety of entry points to the application to provide
 * the base application such as login, sign up, index, app .jade. In addition you can also see other end points
 * for get and post request to manipulate the application state such as createAuction().
 */

var auctionListeners = {};
var currentAuctions = {};
var postAucData = require('../appModules/postAuctionDataGetter');
var auctionCompTasks = require('../appModules/auctionCompletionTasks');
var userUtilities = require('../appModules/userUtilities');
var adminData = require('../appModules/adminData');

module.exports = {

    /**
     * Updates the auction specific variables, this is called by app.js after
     * it has initialised the server... very important if the server ever goes down
     * at any point, a method of updating app state.
     */
    updateAuctionVar : function(currentAucs, aucListeners){
        currentAuctions = currentAucs;
        auctionListeners = aucListeners;
    },

    /**
     * Initialises the routes.js, is called by app.js, also area where the libraries and modules are originally imported.
     *
     * @param app
     * @param passport
     * @param createAuction
     * @param io
     * @param auctionEventEmitter
     */
    init : function(app, passport, createAuction, io, auctionEventEmitter){
        /**
         * Homepage -> Index (LOGIN)
         */
        app.get('/', function(req, res) {
            res.render('index.jade');
        });

        /**
         * Login form
         **/
        app.get('/login', function(req, res) {
            res.render('login.jade', { message: req.flash('loginMessage') });
        });

        /**
         * Process the login form
         */
        app.post('/login', passport.authenticate('local-login', {
                successRedirect : '/app', // redirect to the secure profile section
                failureRedirect : '/login', // redirect back to the signup page if there is an error
                failureFlash : true // allow flash messages
            }),
            function(req, res) {

                if (req.body.remember) {
                    req.session.cookie.maxAge = 1000 * 60 * 3;
                } else {
                    req.session.cookie.expires = false;
                }
                res.redirect('/');
            });

        /**
         * Sign up form
         */
        app.get('/signup', function(req, res) {
            res.render('signup.jade', { message: req.flash('signupMessage') });
        });

        /**
         * Post to process the sign up form (uses Passport.JS)
         */
        app.post('/signup', passport.authenticate('local-signup', {
            successRedirect : '/app', // redirect to the app
            failureRedirect : '/signup', // redirect back to the signup page if there is an error
            failureFlash : true // allow flash messages
        }));


        /**
         * Safety, to ensure a user isLoggedIn then they may view app.jade.
         */
        app.get('/app', isLoggedIn, function(req, res) {
            res.render('app.jade', {
                username          : req.user.username,
                userID            : req.user.id,
                accountType       : req.user.accountType
                // get the user out of session and pass to template
            });
        });

        /**
         * Logout safely
         */
        app.get('/logout', function(req, res) {
            req.logout();
            res.redirect('/');
        });

        /**
         * End point for all auction creation requests
         */
        app.post('/createAuction', function(req, res) {
            createAuction.addAuctionEntry(req.user.id, req.body, function(aucInfo, aucId){
                var auc1 = createAuction
                    .initialiseAuctionEngine(
                        aucInfo, aucId, io, auctionEventEmitter);
                auctionListeners[aucId] = auc1;
                aucInfo.id = aucId;
                currentAuctions[aucId] = aucInfo;
                io.sockets.emit('auctionList', currentAuctions);
                res.end();
            });
            res.end();
        });

        /**
         * End point for auction deletion
         */
        app.post('/deleteAuction', function(req, res){
            var aucID = req.body.id;
            createAuction.deleteAuction(aucID, req.user.id, req.user.accountType, function(id){
                if (currentAuctions.hasOwnProperty(id)
                    &amp;&amp; auctionListeners.hasOwnProperty(id)) {
                    delete currentAuctions[id];
                    delete auctionListeners[id];
                    auctionEventEmitter.emit('delete-' + id);
                    io.sockets.emit('auctionList', currentAuctions);
                }
            });
            res.end();
        });

        /**
         * returns an array of all created auctions dependent on the username/id
         */
        app.get('/completedAuctions', function(req, res) {
            postAucData.getResultsByUserID(req.user.id, 'creator', function(results){
                res.send(JSON.stringify(results));
            });
        });

        /**
         * returns an array of all won auctions dependent on the username/id
         */
        app.get('/wonAuctions', function(req, res) {
            postAucData.getResultsByUserID(req.user.id, 'winner', function(results){
                res.send(JSON.stringify(results));
            });
        });

        /**
         * responds with an array of all unresolved auctions dependent on the username/id
         */
        app.get('/unresolvedAuctions', function(req, res) {
            postAucData.getUnresolvedByUserID(req.user.id, function (unresolvedList) {
                res.send(JSON.stringify(unresolvedList));
            });
        });

        /**
         * Returns the user details given an id
         */
        app.get('/contactDetails', function(req, res){
            postAucData.getContactDetailsByUserID(req.query.id, function(contactDetails){
                res.send(JSON.stringify(contactDetails));
            })
        });

        /**
         * Updates user profile info end point
         */
        app.get('/updateProfile', function(req, res){
            userUtilities.updateUserProfile(req.user.id, req.query, function (hasUpdated) {
               res.send(hasUpdated);
            });
        });

        /**
         * Get all user details - for admin
         */
        app.get('/allUserDetails', function(req, res){
            if(req.user.accountType === 'Admin'){
                adminData.getUserDetails(function(userDetails){
                    res.send(JSON.stringify(userDetails));
                });
            }
            else{
                res.send([])
            }

        });

        /**
         * Delete user
         */
        app.get('/deleteUser', function(req, res){
            if(req.user.accountType === 'Admin'){
                adminData.deleteUser(req.query.userID, function(hasDeleted){
                    res.send(hasDeleted);
                });
            }
            else{
                res.send(false);
            }
        });

        /**
         * Get suspicious users
         */
        app.get('/getSuspiciousUsers', function(req, res){
           createAuction.getSuspiciousUsers(function(suspUsers){
               res.send(JSON.stringify(suspUsers));
           });
        });

        /**
         * Set listener for auction move event
         */
        auctionCompTasks.moveAuctionCompletedListener(auctionEventEmitter);

        /**
         * Updates the auction variable on this script whenever this event is heard
         */
        auctionEventEmitter.on('completedAucMoved', function(aucID) {
            if (currentAuctions.hasOwnProperty(aucID)
                &amp;&amp; auctionListeners.hasOwnProperty(aucID)) {
                delete currentAuctions[aucID];
                delete auctionListeners[aucID];
                io.sockets.emit('auctionList', currentAuctions);
            }
        });

    }

};

/**
 * isLoggedIn detects whether a user is logged in
 **/
function isLoggedIn(req, res, next) {

    // if user is authenticated in the session, carry on
    if (req.isAuthenticated())
        return next();

    // if they are not redirect them to the home page
    res.redirect('/');
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#auctionListeners">auctionListeners</a></li><li><a href="global.html#isLoggedIn">isLoggedIn</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Mar 22 2017 20:43:34 GMT+0000 (GMT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
